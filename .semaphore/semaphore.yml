version: v1.0
name: Go
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: Test
    task:
      jobs:
      - name: go test
        commands:
          - sem-version go 1.11
          - "export GO111MODULE=on"
          - "export GOPATH=~/go"
          - "export PATH=/home/semaphore/go/bin:$PATH"
          - checkout
          - go test ./...
  - name: Push Docker image to registry
    task:
      jobs:
      - name: Docker Hub
        commands:
          - checkout
          - echo $DOCKER_PASSWORD | docker login --username "$DOCKER_USERNAME" --password-stdin
          - docker build -t semaphore:"$SEMAPHORE_WORKFLOW_NUMBER" .
          - docker tag semaphore:"$SEMAPHORE_WORKFLOW_NUMBER" "$DOCKER_USERNAME"/semaphore:"$SEMAPHORE_WORKFLOW_NUMBER"
          - docker push "$DOCKER_USERNAME"/semaphore:"$SEMAPHORE_WORKFLOW_NUMBER"
      secrets:
      - name: docker-hub